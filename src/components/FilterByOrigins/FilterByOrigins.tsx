import { setIsDebouncing, setSlectedOrigins } from "features/products/productsSlice";
import { getOrigins } from "features/products/selectors";
import { ISelectedOrigins } from "features/products/types";
import { useDebounce } from "hooks/useDebounce";
import React, { useCallback, useMemo } from "react";
import { useDispatch, useSelector } from "react-redux";
import Select, { OptionsType } from "react-select";
import s from "./FilterByOrigins.module.scss";

type TProps = {
  selectedOriginsQuery: ISelectedOrigins[];
  setSelectedOriginsQuery: (origins: string) => void;
};

export const FilterByOrigins: React.FC<TProps> = ({
  selectedOriginsQuery,
  setSelectedOriginsQuery,
}) => {
  const origins = useSelector(getOrigins);
  const dispatch = useDispatch();
  const options = useMemo(
    () =>
      origins.map((origin) =>
        Object({
          value: origin.value,
          label: origin.displayName,
        })
      ),
    [origins]
  );

  const handleClick = useDebounce((selected: OptionsType<ISelectedOrigins>) => {
    dispatch(setSlectedOrigins(selected));
    setSelectedOriginsQuery(selected ? selected.map((item) => item.value).join(",") : "");
    dispatch(setIsDebouncing(false));
  });

  const handleSelect = useCallback((selected: OptionsType<ISelectedOrigins>) => {
    dispatch(setIsDebouncing(true));
    handleClick(selected);
  }, []);

  return (
    <div className={s["filter-by-origins"]}>
      <div className={s["filter-by-origins__label"]}>Filter By Origin</div>
      <Select
        isMulti
        name="origins"
        options={options}
        className="basic-multi-select"
        classNamePrefix="select"
        onChange={handleSelect}
        defaultValue={selectedOriginsQuery}
      />
    </div>
  );
};
